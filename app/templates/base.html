<!doctype html>
<html lang="{{ 'en' if session.get('lang','es') == 'en' else 'es' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}CV Match Scanner{% endblock %}</title>

  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">

  <!-- CSP: añade paypal.com (scripts/frames) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval';
                script-src 'self' https: 'unsafe-inline' 'unsafe-eval' https://www.paypal.com;
                frame-src 'self' https: data: https://www.paypal.com https://*.paypal.com;
                img-src 'self' https: data: blob:;
                connect-src 'self' https:;
                style-src 'self' https: 'unsafe-inline';">
  
  <!-- PayPal LINK -->
  <!-- <script 
    src="https://www.paypal.com/sdk/js?client-id=BAAc837KUU2muz35CHRVhWS-DVVqKXPMToq84j8O8gqtxlEGXP2kutIh60YJ80aPW9Jm8rYuKKWOSqQTYA&components=hosted-buttons&disable-funding=venmo&currency=USD">
  </script> -->

  <!-- En <head> deja estas reglas -->
  <style>
    /* Fondo minimal: gradiente + grilla sutil */
    :root { --bg1:#f7f9fc; --bg2:#eef3f9; }
    body {
      padding-top: 4.5rem; /* por el navbar fijo */
      background:
        radial-gradient(circle at 25% 10%, rgba(255,255,255,.9) 0 40%, transparent 41%),
        radial-gradient(circle at 75% 0%,  rgba(255,255,255,.8) 0 35%, transparent 36%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    /* trama de puntos MUY sutil encima */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image: radial-gradient(#00000010 1px, transparent 1px);
      background-size: 12px 12px;
      pointer-events:none;
    }

    .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    
    .navbar-brand:focus, .navbar-brand:focus-visible { outline: none !important; box-shadow: none !important; }
    .navbar-brand img { height: 24px; width: auto; display: inline-block; } 
    
    .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .avatar-fallback {
      width: 36px; height: 36px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.9rem; color: #fff; background:#6c757d;
    }

    /* Más espacio inferior al contenido para que no se pegue al footer */
    main.container { padding-bottom: 2rem; }

    /* Tarjeta de sugerencias: textarea bajito */
    .suggestions-textarea {
      min-height: 70px;   /* altura deseada */
      max-height: 120px;  /* evita crecer demasiado */
      resize: vertical;   /* el usuario puede estirar si quiere */
    }
    
    /* Footer más alto y con zona de colaboradores/patrocinadores */
    footer { background: #fff; border-top: 1px solid #dee2e6; padding: 1rem 0; }
    footer.site-footer {
      background: #fff;
      border-top: 1px solid #dee2e6;
      padding: 2rem 0;              /* antes era ~1rem, ahora más alto */
    }

    .footer-top {
      display: flex; 
      flex-wrap: wrap; 
      gap: 1rem; 
      align-items: center; 
      justify-content: space-between;
    }

    .sponsors {
      display: flex; 
      flex-wrap: wrap; 
      gap: 1rem;
    }
    .sponsors img {
      height: 28px; 
      opacity: .85; 
      filter: grayscale(100%); 
      transition: opacity .2s, filter .2s;
    }
    .sponsors img:hover {
      opacity: 1; 
      filter: none;
    }

    .footer-bottom {
      margin-top: .75rem; 
      font-size: .9rem; 
      color: #6c757d;
    }

    #loadingOverlay{
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(255,255,255,.8);
        display: none;                  /* SIEMPRE oculto por defecto */
        align-items: center;            /* centrado sin depender de d-flex */
        justify-content: center;
        flex-direction: column;
      }
    #loadingOverlay.is-visible{ display: flex; } 

    .btn-warning {
      border: 1px solid #d39e00; /* tono amarillo un poco más oscuro */
    }
    /* Modal Donar: ancho cómodo y centrado del contenido */
    .modal-donate .modal-content{ border-radius:1rem; }
    .modal-donate .modal-body{ padding:1.25rem 1.5rem; }

    /* Contenedor interno centrado: limita el ancho de párrafos */
    .modal-donate .centered { max-width: 560px; margin-inline: auto; }

    /* Justificar texto (Bootstrap 5 no trae utilitario .text-justify) */
    .text-justify { text-align: justify; }

    /* Centrar el contenedor de PayPal y darle un ancho razonable */
    #paypal-container-navbar { max-width: 380px; margin: 1rem auto 0; }

  </style>

{% block extra_head %}
{% endblock %}

</head>
<body class="d-flex flex-column min-vh-100">
  <!-- Navbar -->  
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('main.index') }}">
        <!-- usa tu archivo real: favicon-32x32.png/png en static -->
        <img src="{{ url_for('static', filename='favicon-32x32.png') }}" alt="CV Match Scanner">
        <span class="fw-bold mb-0">CV Match Scanner</span>
      </a>
      
      {% set is_en = (session.get('lang','es') == 'en') %}
      {% set tpl_path = 'docs/ATS_CV_Template_English.docx' if is_en else 'docs/Plantilla_CV_ATS_STAR.docx' %}
      {% set video_url = 'https://youtu.be/AnsaNKotmO0' if is_en else 'https://youtu.be/4icmc4kkPEY' %}

      <div class="d-flex align-items-center">
        <!-- Botón Template -->
        <a class="btn btn-sm btn-outline-primary me-2"
          href="{{ url_for('static', filename=tpl_path) }}"
          download>
          <i class="bi bi-file-earmark-word"></i>
          {{ 'ATS Resume Template' if is_en else 'Plantilla CV ATS' }}
        </a>

        <!-- Botón Video -->
        <a class="btn btn-sm btn-outline-primary me-2"
          href="{{ video_url }}" target="_blank" rel="noopener">
          <i class="bi bi-play-circle"
            data-bs-toggle="tooltip"
            data-bs-placement="top"
            title="{{ 'Watch explainer video' if is_en else 'Ver video explicativo' }}"></i>
          {{ 'What is an ATS?' if is_en else '¿Qué es un ATS?' }}
        </a>

        <!-- Botón Donar -->
        <a href="https://www.paypal.com/ncp/payment/86XQCYFDC3VSN" 
          target="_blank" rel="noopener"
          class="btn-sm btn btn-primary me-2">
          <i class="bi bi-heart-fill"></i> {{ 'Donate' if is_en else 'Donar' }}
        </a>

        <!-- Selector de idioma -->
        <div class="dropdown me-3">
          <button class="btn btn-sm btn-outline-primary dropdown-toggle d-flex align-items-center" 
                  type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            {% if is_en %}
              <span class="fi fi-us me-2"></span> English
            {% else %}
              <span class="fi fi-es me-2"></span> Español
            {% endif %}
          </button>
          <ul class="dropdown-menu" aria-labelledby="langDropdown">
            <li>
              <a class="dropdown-item d-flex align-items-center" href="#" onclick="changeLang('es')">
                <span class="fi fi-es me-2"></span> Español
              </a>
            </li>
            <li>
              <a class="dropdown-item d-flex align-items-center" href="#" onclick="changeLang('en')">
                <span class="fi fi-us me-2"></span> English
              </a>
            </li>
          </ul>
        </div>

        {% if session.get('user_email') %}
          {% set uname = (session.get('user_name') or session.get('user_email') or '') %}
          {% set parts = uname.split() %}
          {% set initials = (parts[0][0] if parts and parts[0] else '') ~ (parts[1][0] if parts|length>1 and parts[1] else '') %}
          <span class="position-relative d-inline-flex align-items-center me-2">
            <img
              class="avatar me-2"
              src="{{ session.get('user_picture') or '' }}"
              alt="avatar"
              referrerpolicy="no-referrer"
              crossorigin="anonymous"
              onerror="this.style.display='none'; this.nextElementSibling.classList.remove('d-none');">
            <span class="avatar-fallback d-none">{{ initials|upper or 'U' }}</span>
          </span>
          <span class="me-3 d-none d-md-inline">{{ session.get('user_name') or session.get('user_email') }}</span>

          {% if config.get('ADMIN_EMAIL') and session.get('user_email') and session.get('user_email')|lower == config.get('ADMIN_EMAIL')|lower %}
            <div class="btn-group me-2">
              <button class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-speedometer2"></i> Admin
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{{ url_for('admin.panel') }}"><i class="bi bi-house-door"></i> Panel</a></li>
                <li><hr class="dropdown-divider"></li>
                <li class="dropdown-header">Memberships</li>
                <li><a class="dropdown-item" href="{{ url_for('admin.memberships_list') }}"><i class="bi bi-people"></i> Listado</a></li>
                <li><a class="dropdown-item" href="{{ url_for('admin.memberships_new') }}"><i class="bi bi-plus-circle"></i> Nuevo nivel</a></li>
                <li><hr class="dropdown-divider"></li>
                <li class="dropdown-header">Usuarios</li>
                <li><a class="dropdown-item" href="{{ url_for('admin.users_list') }}"><i class="bi bi-person-lines-fill"></i> Usuarios</a></li>
                <li class="dropdown-header">Historial</li>
                <li><a class="dropdown-item" href="{{ url_for('history.history') }}"><i class="bi bi-person-lines-fill"></i> Historial</a></li>
              </ul>
            </div>
          {% endif %}

          <a class="btn btn-sm btn-outline-danger" href="{{ url_for('auth.logout') }}">
            <i class="bi bi-box-arrow-right"></i> {{ 'Sign out' if is_en else 'Salir' }}
          </a>
        {% else %}
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('auth.login') }}">
            <i class="bi bi-google"></i> {{ 'Sign in' if is_en else 'Iniciar sesión' }}
          </a>
        {% endif %}
      </div>
    </div>
  </nav>

  <!-- Contenido -->
  <main class="container flex-grow-1">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'info' if cat=='message' else cat }} alert-dismissible fade show mt-3" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">

      <div class="mt-3">
        <div class="fw-semibold mb-1">{{ t('donate_blurb.title') }}</div>
        <p class="small text-muted mb-2" style="max-width: 200ch; text-align: justify; padding-bottom: 20px;">
          {{ t('donate_blurb.body') }}
        </p>
      </div>

      <div class="footer-top">
        <div>
          <div class="fw-semibold">
            {{ 'Collaborators & Sponsors' if is_en else 'Colaboradores y patrocinadores' }}
          </div>
          <div class="small text-muted">
            {{ 'Thanks to our supporters' if is_en else 'Gracias a quienes apoyan el proyecto' }}
          </div>
        </div>

        <!-- Logos/links de ejemplo; puedes cambiar rutas/archivos -->
        <div class="sponsors">
          <a href="#" aria-label="Sponsor A">
            <img src="{{ url_for('static', filename='sponsors/sponsor-a.svg') }}"
                alt="Sponsor A"
                onerror="this.replaceWith(document.createTextNode('Sponsor A'))">
          </a>
          <a href="#" aria-label="Sponsor B">
            <img src="{{ url_for('static', filename='sponsors/sponsor-b.svg') }}"
                alt="Sponsor B"
                onerror="this.replaceWith(document.createTextNode('Sponsor B'))">
          </a>
          <!-- agrega más logos si lo necesitas -->
        </div>
      </div>

      <div class="footer-bottom d-flex flex-column flex-md-row justify-content-between align-items-center">
        <div>
          &copy; {{ current_year }} CV Match Scanner ·
          {{ 'Built by Ricardo Carruyo' if is_en else 'Desarrollado por Ricardo Carruyo' }} ·
          {{ 'Local version' if is_en else 'Versión local' if version=='v0' else ('Versión ' ~ version) }}
        </div>
        <div>         
          <i class="bi bi-envelope">{{ ' Contact: ' if is_en else ' Contacto: ' }}</i>
          <a class="text-decoration-none" href="mailto:cvmatchscanner@gmail.com">
            cvmatchscanner@gmail.com
          </a>
        </div>
      </div>

    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function changeLang(lang) {
      fetch("{{ url_for('main.set_lang') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({lang})
      })
      .then(() => location.reload())
      .catch(() => location.reload());
    }
  </script>
  <!-- Modal límite de análisis -->
  <div class="modal fade" id="limitModal" tabindex="-1" aria-labelledby="limitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="limitModalLabel">{{ t('limit_modal.title') }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('limit_modal.close') }}"></button>
        </div>
        <div class="modal-body">
          <p class="text-justify">{{ t('limit_modal.body', limit=(limit_for_modal or 10)) }}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('limit_modal.close') }}</button>
          <!-- Botón Donar -->
          <a href="https://www.paypal.com/ncp/payment/86XQCYFDC3VSN" 
            target="_blank" rel="noopener"
            class="btn btn-primary">
            <i class="bi bi-heart-fill"></i> {{ 'Donate' if is_en else 'Donar' }}
          </a>
        </div>
      </div>
    </div>
  </div>

  {% if show_limit_modal %}
  <script>
    (function(){
      const el = document.getElementById('limitModal');
      if (!el) return;
      try {
        var modal = new bootstrap.Modal(el, { backdrop: 'static', keyboard: true });
        modal.show();
      } catch(e) { console.error(e); }
    })();
  </script>
  {% endif %}

  <!-- Modal Donaciones (navbar) -->
  <div class="modal fade" id="donateModal" tabindex="-1" aria-labelledby="donateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-donate">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="donateModalLabel" class="modal-title text-center w-100">
            {{ 'Support the project' if is_en else 'Apoya el proyecto' }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="{{ 'Close' if is_en else 'Cerrar' }}"></button>
        </div>

        <div class="modal-body">
          <div class="centered">
            <p class="fw-semibold text-center mb-3">
              {{ 'Your donation helps keep the service online and improve features.'
                if is_en else
                'Tu donación ayuda a mantener el servicio en línea y mejorar funcionalidades.' }}
            </p>
            <!-- Contenedor PayPal (centrado y con ancho fijo) -->
            <!-- Botón Donar (link directo de PayPal) -->
            <a href="https://www.paypal.com/ncp/payment/86XQCYFDC3VSN" 
              target="_blank" rel="noopener"
              class="btn btn-warning w-100 mb-2">
              <i class="bi bi-paypal"></i> {{ 'Donate with PayPal' if is_en else 'Donar con PayPal' }}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de carga -->
  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width:4rem;height:4rem;">
      <span class="visually-hidden">{{ t('overlay.processing.alt') }}</span>
    </div>
    <p class="mt-3 fw-bold">{{ t('overlay.processing') }}</p>
  </div>

  <script>
    // Renderiza HostedButtons en el selector indicado (solo una vez)
    // function renderPaypal(containerSelector) {
    //   if (!window.paypal) return; // SDK aún no cargado
    //   const el = document.querySelector(containerSelector);
    //   if (!el || el.dataset.rendered === "1") return;
    //   paypal.HostedButtons({ hostedButtonId: "8SBMAGAYSMREU" }).render(containerSelector);
    //   el.dataset.rendered = "1";
    // }

    // Cuando se muestre el modal de donaciones (navbar)
    // document.addEventListener('shown.bs.modal', function (e) {
    //   if (e.target && e.target.id === 'donateModal') {
    //     renderPaypal('#paypal-container-navbar');
    //   }
    // });

    // // (Opcional) Si tienes un modal de límite alcanzado:
    // document.addEventListener('shown.bs.modal', function (e) {
    //   if (e.target && e.target.id === 'limitModal') {
    //     renderPaypal('#paypal-container-limit');
    //   }
    // });

    // // Fallback: si el modal ya está visible cuando el SDK termina de cargar
    // window.addEventListener('load', function(){
    //   const dm = document.getElementById('donateModal');
    //   if (dm && dm.classList.contains('show')) {
    //     renderPaypal('#paypal-container-navbar');
    //   }
    // });
  </script>  

<script>
  (function () {
    const overlay = document.getElementById('loadingOverlay');
    const form    = document.getElementById('analyzeForm');   // <form id="analyzeForm">
    const btn     = document.getElementById('btn-analyze');   // <button id="btn-analyze" type="submit">
    let userClick = false;

    if (!form || !btn) return;
    
    form.addEventListener('submit', () => {
      // Deshabilita el botón para evitar re-clicks
      btn.disabled = true;
      // Por si otro validador cancela el envío, re-habilita en el siguiente tick
      setTimeout(() => { if (document.activeElement !== btn) btn.disabled = false; }, 1000);
    });
    
    // Al volver con “Atrás”, re-habilita
    window.addEventListener('pageshow', () => { btn.disabled = false; });

    if (!overlay || !form) return;
    
    // Asegurar oculto al cargar / volver con "Atrás"
    overlay.classList.remove('is-visible');
    window.addEventListener('pageshow', () => overlay.classList.remove('is-visible'));

    // El usuario hizo click en nuestro botón
    if (btn) btn.addEventListener('click', () => { userClick = true; }, {capture:true});

    form.addEventListener('submit', (e) => {
      // ¿quién dispara el submit?
      const submitter = e.submitter || document.activeElement;

      // Solo si lo disparó nuestro botón o userClick=true
      if (!userClick && submitter !== btn) return;

      // Validaciones mínimas para no mostrar si se cancela luego
      const fi = document.getElementById('file-input');
      const jd = document.getElementById('jobdesc');
      const ok = (fi && fi.files && fi.files.length > 0) &&
      (jd && jd.value && jd.value.trim().length > 0);
      
      // Espera 1 tick por si otro listener hace preventDefault()
      setTimeout(() => {
        if (e.defaultPrevented || !ok) { userClick = false; return; }
        overlay.classList.add('is-visible');
      }, 0);
    }, false);
    
    // Seguridad extra: si hubiera navegación inmediata
    window.addEventListener('unload', () => overlay.classList.remove('is-visible'));
  })();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
