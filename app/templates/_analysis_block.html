{# templates/_analysis_block.html #}
{#
  Variables esperadas en el render:
  - score_jd (int 0–100)
  - score_ats (int 0–100)
  - feedback        (HTML ya sanitizado)
  - disclaimer      (str | opcional)
  - ats_details     (obj | opcional)
  - model_used      (1=openai, 2=gemini | opcional)
  - exec_id         (int | opcional)
  - max_mb          (int | opcional)
  - print_mode      (bool | opcional)
  - is_en           (bool) → idioma activo
  - t(key)          → función de traducción
#}

<div class="card p-4 shadow-sm mt-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 id="ai-analysis" class="mb-0">{{ t('ai.title') }}</h3>

    {% if not print_mode %}
      <div class="d-flex gap-2">
        {% if model_used == 1 %}
          <span class="badge text-bg-primary model-badge">
            <i class="bi bi-cpu"></i> {{ t('ai.model_1') }}
          </span>
        {% elif model_used == 2 %}
          <span class="badge text-bg-success model-badge">
            <i class="bi bi-stars"></i> {{ t('ai.model_2') }}
          </span>
        {% endif %}
        {% if exec_id %}
          <a class="btn btn-sm btn-outline-secondary" target="_blank"
             href="{{ url_for('history.print_view', exec_id=exec_id) }}">
            <i class="bi bi-printer"></i> {{ t('ai.download_print') }}
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {# ===== Donas ===== #}
  <div class="row g-3 align-items-center analysis-meters">
    <div class="col-12 col-lg-6">
      <div class="donut-host">
        <div class="donut" data-score="{{ score_jd|default(0, true)|int }}">
          <div class="donut-wrap">
            <svg viewBox="-2 -2 40 40" class="donut-svg" aria-label="{{ t('ai.match_jd') }}" overflow="visible">
              <circle class="donut-track"     cx="18" cy="18" r="15" pathLength="100"></circle>
              <circle class="donut-indicator" cx="18" cy="18" r="15" pathLength="100"></circle>
            </svg>
            <div class="donut-label">{{ score_jd|default(0, true)|int }}%</div>
          </div>
          <div class="small text-muted mt-2 text-center">{{ t('ai.match_jd') }}</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="donut-host">
        <div class="donut" data-score="{{ score_ats|default(0, true)|int }}">
          <div class="donut-wrap">
            <svg viewBox="-2 -2 40 40" class="donut-svg" aria-label="{{ t('ai.match_ats') }}" overflow="visible">
              <circle class="donut-track"     cx="18" cy="18" r="15" pathLength="100"></circle>
              <circle class="donut-indicator" cx="18" cy="18" r="15" pathLength="100"></circle>
            </svg>
            <div class="donut-label">{{ score_ats|default(0, true)|int }}%</div>
          </div>
          <div class="small text-muted mt-2 text-center">{{ t('ai.match_ats') }}</div>
        </div>
      </div>
    </div>
  </div>

  {% if disclaimer %}
    <div class="alert alert-info mt-3" role="alert">{{ disclaimer }}</div>
  {% endif %}

  {# ===== Checklist ATS ===== #}
  {% if ats_details %}
    <div class="card mt-3 mb-2 p-3">
      <h6 class="fw-bold mb-3">{{ t('ai.checklist_title') }}</h6>

      {# Fallback para compatibilidad: si no viniera "checks", lo derivamos de los campos antiguos #}
      {% set c = ats_details.checks if ats_details.checks is defined else {
        'perfil':              ('perfil profesional'   in (ats_details.sections_present or [])),
        'experiencia':         ('experiencia laboral'  in (ats_details.sections_present or [])),
        'educacion':           ('educación'            in (ats_details.sections_present or [])),
        'habilidades':         ('habilidades'          in (ats_details.sections_present or [])),
        'idiomas':             ('idiomas'              in (ats_details.sections_present or [])),
        'no_imagenes':         (not ats_details.has_images),
        'no_tablas':           (not ats_details.has_tables_or_columns),
        'tipografia_segura':   (ats_details.safe_typography == true),
        'paginas_ok':          ((ats_details.pages or 0) <= 2)
      } %}

      <div class="row gy-2 gx-4">
        {# 1–5) Secciones equivalentes #}
        {% set sec_labels = {
            'perfil':      t('sec.profile'),
            'experiencia': t('sec.experience'),
            'educacion':   t('sec.education'),
            'habilidades': t('sec.skills'),
            'idiomas':     t('sec.languages')
          } %}

        {% for key in ['perfil','experiencia','educacion','habilidades','idiomas'] %}
          <div class="col-12 col-sm-6 col-lg-4 d-flex align-items-center">
            {% set ok = c[key] %}
            <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-x-circle-fill text-danger' }} me-2"></i>
            <span>{{ sec_labels[key] }}</span>
          </div>
        {% endfor %}

        {# 6) Sin imágenes #}
        <div class="col-12 col-sm-6 col-lg-4 d-flex align-items-center">
          {% set ok = c.no_imagenes %}
          <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-x-circle-fill text-danger' }} me-2"></i>
          <span>{{ t('ai.images_in_cv') }}:
            <strong>{{ t('common.no') if ok else t('common.yes') }}</strong>
          </span>
        </div>

        {# 7) Sin tablas/columnas #}
        <div class="col-12 col-sm-6 col-lg-4 d-flex align-items-center">
          {% set ok = c.no_tablas %}
          <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-x-circle-fill text-danger' }} me-2"></i>
          <span>{{ t('ai.tables_or_columns') }}:
            <strong>{{ t('common.no') if ok else t('common.yes') }}</strong>
          </span>
        </div>

        {# 8) Tipografía segura #}
        <div class="col-12 col-sm-6 col-lg-4 d-flex align-items-center">
          {% set ok = c.tipografia_segura %}
          <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-x-circle-fill text-danger' }} me-2"></i>
          <span>{{ t('ai.safe_typography') }}:
            <strong>{{ t('common.yes') if ok else t('common.no') }}</strong>
          </span>
        </div>

        {# 9) Páginas ≤ 2 (muestra el número real si lo tienes) #}
        <div class="col-12 col-sm-6 col-lg-4 d-flex align-items-center">
          {% set ok = c.paginas_ok %}
          <i class="bi {{ 'bi-check-circle-fill text-success' if ok else 'bi-x-circle-fill text-danger' }} me-2"></i>
          <span>
            {{ t('ai.pages_leq2') }}
            {% if ats_details.pages is defined and ats_details.pages %}
              <small class="text-muted">({{ t('ai.pages_current') }}: {{ ats_details.pages }})</small>
            {% endif %}
          </span>
        </div>
      </div>
    </div>
  {% endif %}

  {# ===== Feedback del modelo ===== #}
  <div class="mt-3">
    {{ feedback|safe }}
  </div>

  {# ===== Lineamientos ===== #}
  <hr class="my-4">
  <h5 class="mb-2">{{ t('lineamientos.title') }}</h5>
  <ul class="small mb-2">
    {# "panel.guidelines.items" viene como string con ';;' entre ítems #}
    {% set gl_items = t('panel.guidelines.items', max_mb=(max_mb or 2)) %}
    {% for it in gl_items.split(';;') %}
      <li>{{ it|safe }}</li>
    {% endfor %}
    {% if not print_mode %}
      <li>
        <a class="link-primary"
          href="{{ url_for('static', filename=('docs/ATS_CV_Template_English.docx' if (lang=='en') else 'docs/Plantilla_CV_ATS_STAR.docx')) }}"
          download>
          {{ t('panel.guidelines.download') }}
        </a>
      </li>
    {% else %}
      <li>{{ t('panel.guidelines.download') }}</li>
    {% endif %}
  </ul>


  <div class="row">
    <div class="col-md-6">
      <div class="fw-semibold small">{{ t('guide.sections_equiv_title') }}</div>
      <ul class="small mb-3">
        <li><strong>{{ t('sec.profile') }}</strong> → {{ t('guide.sec_profile_equiv')|safe }}</li>
        <li><strong>{{ t('sec.experience') }}</strong> → {{ t('guide.sec_experience_equiv')|safe }}</li>
        <li><strong>{{ t('sec.education') }}</strong> → {{ t('guide.sec_education_equiv')|safe }}</li>
        <li><strong>{{ t('sec.skills') }}</strong> → {{ t('guide.sec_skills_equiv')|safe }}</li>
        <li><strong>{{ t('sec.languages') }}</strong> → {{ t('guide.sec_languages_equiv')|safe }}</li>
      </ul>
    </div>
    <div class="col-md-6">
      <div class="fw-semibold small">{{ t('guide.star_title') }}</div>
      <p class="small mb-1">{{ t('guide.star_intro') }}</p>
      <ul class="small mb-0">
        <li>{{ t('guide.star_s')|safe }}</li>
        <li>{{ t('guide.star_t')|safe }}</li>
        <li>{{ t('guide.star_a')|safe }}</li>
        <li>{{ t('guide.star_r')|safe }}</li>
      </ul>
    </div>
  </div>
</div>
