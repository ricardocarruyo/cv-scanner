{% extends "base.html" %}
{% block title %}Inicio · {{ t('app.title') }}{% endblock %}

{% block extra_head %}
<style>
  .gauge-wrap { position: relative; width: 100%; max-width: 460px; margin: 0 auto; aspect-ratio: 2 / 1; }
  .gauge { width: 100%; height: 100%; }
  .needle { transform-origin: 50% 100%; transition: transform 0.8s ease-in-out; }
  .score-label { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); font-size: 1.75rem; font-weight: 700; }
  .model-badge { font-size: .9rem; }

  /* Contenedor que hospeda cada donut dentro de la grilla */
  .analysis-meters .donut-host {
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;
    min-height: 160px;
  }

  .donut-wrap   { position: relative; width: 180px; height: 180px; }
  .donut-svg    { width: 100%; height: 100%; transform: rotate(-90deg); }

  .donut-track { fill: none; stroke: #eee; stroke-width: 4.5; }
  .donut-indicator {
    fill: none;
    stroke: var(--donut-color, #28a745);
    stroke-width: 4.5;
    stroke-linecap: round;
    stroke-dasharray: var(--dash, 0) 100;
    transition: stroke-dasharray .6s ease, stroke .3s ease;
  }
  .donut-label {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 1.1rem;
  }
  @media (max-width: 991.98px) {
    .analysis-meters .donut-host { min-height: 200px; }
    .donut-wrap { width: 160px; height: 160px; }
  }

  #dropzone { border-style: dashed; }
  .dropzone.dragover { background-color:#f8f9fa; border-color:#0d6efd; }
  .dropzone.ok { border-color:#198754; background: var(--bs-success-bg-subtle, #eaf6ed); }

  #jobdesc {
    max-height: 160px;
    overflow-y: auto;
    overflow-x: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Indicadores circulares 1–2–3 */
  .badge-circle{
    --on-bg: #0d6efd;
    --off-bg:#e9ecef;
    --on-fg:#fff;
    --off-fg:#6c757d;

    width: 32px; height: 32px; border-radius: 50%;
    display: inline-grid; place-items: center;
    font-weight: 700; font-size: .95rem;
    background: var(--off-bg); color: var(--off-fg);
    border: 2px solid #dee2e6;
    transition: background .2s ease, color .2s ease, box-shadow .2s ease;
    box-shadow: 0 0 0 0 rgba(13,110,253,0);
    line-height: 1;
  }
  .badge-circle.is-on{
    background: var(--on-bg); color: var(--on-fg); border-color: var(--on-bg);
    box-shadow: 0 0 0 4px rgba(13,110,253,.15);
  }

  /* Parpadeo suave cuando ③ está listo */
  @keyframes pulse {
    0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(13,110,253,.35); }
    70%  { transform: scale(1.06); box-shadow: 0 0 0 10px rgba(13,110,253,0); }
    100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(13,110,253,0); }
  }
  .badge-circle.is-ready{
    background:#28a745; border-color:#28a745;
    color:#fff;
    animation: pulse 1.4s ease-in-out infinite;
  }

  .label-with-badge{ display:flex; align-items:center; gap:.5rem; }
  .before-button{ display:flex; align-items:center; gap:.5rem; }

  /* ===== Hero (landing antes de iniciar sesión) ===== */
  .hero-wrap{
    min-height: calc(100vh - 5rem);
    display: grid;
    align-items: center;
    padding: 2rem 0 3rem;
  }
  .hero-title{
    font-weight: 800;
    line-height: 1.05;
    letter-spacing: -0.5px;
    font-size: clamp(1.8rem, 2.8vw + 1rem, 3.2rem);
  }
  .hero-sub{
    color: #6c757d;
    max-width: 48ch;
  }
  .hero-cta{
    padding: .9rem 1.2rem;
    font-weight: 700;
    border-width: 2px;
  }
  .hero-art{
    width: 100%;
    height: auto;
    max-width: 780px;
    border-radius: .5rem;
    box-shadow: 0 8px 28px rgba(0,0,0,.08);
  }
  .stepper-img{
    width: 100%;
    max-width: 880px;
    height: auto;
    opacity: .95;
    display: block;
    margin-inline: auto;
  }
  .hero-muted{
    font-size: .95rem;
    color: #6c757d;
  }
</style>
{% endblock %}

{% block content %}
  <div class="container mt-3">
    <div class="row g-4 mb-4 equal-panels">
      <!-- IZQUIERDA: FORM -->
      <div class="col-12 col-lg-6 pt-0 pb-0 ps-0 pe-3">
        <div class="card p-4 shadow-sm h-100">
          {% if not session.get('user_email') %}
            <!-- ===== Landing / Hero (visitante sin sesión) ===== -->
            <section class="hero-wrap">
              <div class="container">
                <div class="row g-5 align-items-center">
                  <!-- Texto + CTA -->
                  <div class="col-12 col-lg-6">
                    <h1 class="hero-title">
                      {{ is_en and "Optimize your resume to get more interviews" 
                                or  "Optimiza tu CV para conseguir más entrevistas" }}
                    </h1>
                    <p class="hero-sub mt-3">
                      {{ is_en and
                        "Our scanner highlights the experience and skills recruiters and ATS need to see for any job."
                        or
                        "Nuestro escáner resalta la experiencia y habilidades que reclutadores y ATS necesitan ver para cualquier puesto."
                      }}
                    </p>

                    <a class="btn btn-primary btn-lg hero-cta mt-3"
                      href="{{ url_for('auth.login') }}">
                      {{ is_en and "Scan Your Resume For Free" or "Escanea tu CV Gratis" }}
                    </a>

                    <p class="hero-muted mt-3">
                      {{ is_en and "No credit card required." or "No requiere tarjeta de crédito." }}
                    </p>
                  </div>

                  <!-- Mockup -->
                  <div class="col-12 col-lg-6 text-center">
                    <img
                      src="{{ url_for('static', filename='Intro.png') }}"
                      alt="{{ is_en and 'Resume scan mockup' or 'Mockup del análisis de CV' }}"
                      class="hero-art"
                      loading="lazy">
                  </div>
                </div>

                <!-- Stepper -->
                <div class="mt-5">
                  <img
                    src="{{ url_for('static', filename='Stepper.png') }}"
                    alt="{{ is_en and 'Steps: Upload Resume · Add Job · View Results' 
                                or 'Pasos: Subir CV · Agregar Puesto · Ver Resultados' }}"
                    class="stepper-img"
                    loading="lazy">
                </div>
              </div>
            </section>            
          {% else %}
            {# ===== Usuario con sesión: muestra tu UI actual (form + panel derecho + resultados) ===== #}
            <form method="post" enctype="multipart/form-data" action="{{ url_for('main.index') }}">
              <!-- Panel de lineamientos corto arriba del form (opcional) -->
              <div class="w-100">
                <h5 class="mb-2">{{ t('panel.guidelines.title') }}</h5>
                <ul class="small mb-3">
                  {% for li in t('panel.guidelines.items', max_mb=max_mb or 2).split(';;') %}
                    <li>{{ li|safe }}</li>
                  {% endfor %}
                  <li>
                    <a class="link-primary"
                       href="{{ url_for('static', filename=(is_en and 'docs/ATS_CV_Template_English.docx' or 'docs/Plantilla_CV_ATS_STAR.docx')) }}"
                       download>
                      {{ t('panel.guidelines.download') }}
                    </a>
                  </li>
                </ul>
              </div>

              <!-- Subida de archivo -->
              <div class="mb-2">
                <label class="form-label label-with-badge">
                  <span id="badge-step1" class="badge-circle">1</span>
                  {{ t('form.upload.label', max_mb=max_mb or 2) }}
                </label>

                <input id="file-input" name="cv" type="file" accept=".pdf,.docx" class="visually-hidden">

                <div id="dropzone"
                     class="dropzone border border-2 rounded-3 p-4 text-center bg-white"
                     style="border-style:dashed; cursor:pointer;">
                  <div class="fw-semibold">{{ t('form.upload.drop_main') }}</div>
                  <div class="text-muted small">{{ t('form.upload.drop_sub') }}</div>
                  <div id="file-name" class="small mt-2 text-secondary"></div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-1">
                  <button type="button" id="btn-clear-file" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eraser"></i> {{ t('form.jd.clear') }}
                  </button>
                </div>

                <div class="form-text">{{ t('form.upload.help') }}</div>
              </div>

              <!-- Job Description -->
              <div class="mb-3">
                <label class="form-label label-with-badge">
                  <span id="badge-step2" class="badge-circle">2</span>
                  {{ t('form.jd.label') }}
                </label>

                <textarea id="jobdesc" name="jobdesc"
                          class="form-control"
                          rows="8"
                          maxlength="4000"
                          required
                          style="overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word; max-height:160px;">{{ jobdesc or '' }}</textarea>

                <div class="d-flex justify-content-between align-items-center mt-1">
                  <button type="button" id="btn-clear-jobdesc" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eraser"></i> {{ t('form.jd.clear') }}
                  </button>
                  <span id="char-count" class="small text-muted">0/4000</span>
                </div>
              </div>

              <!-- Botón + indicador ③ -->
              <div class="before-button">
                <span id="badge-step3" class="badge-circle">3</span>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-search"></i> {{ t('form.analyze') }}
                </button>
              </div>
            </form>
          {% endif %}
        </div>
      </div>

      <!-- DERECHA: LINEAMIENTOS -->
      <div class="col-12 col-lg-6 ps-3 pt-0 pb-0 pe-0">
        <div class="card p-4 shadow-sm h-100 d-flex align-items-stretch">
          <div class="w-100">
            <h5 class="mb-3">{{ t('panel.ats.title') }}</h5>
            <ul class="small">
              {% for li in t('panel.ats.items').split(';;') %}
                <li>{{ li|safe }}</li>
              {% endfor %}
            </ul>

            <h6 class="mt-3">{{ t('panel.syn.title') }}</h6>
            <p class="small text-muted mb-2">{{ t('panel.syn.note') }}</p>
            <ul class="small mb-3">
              <li>
                <strong>{{ is_en and "Professional Profile" or "Perfil profesional" }}</strong>
                → {{ is_en and "Professional Summary, Summary, Objective(s), Profile" or "Resumen profesional, Resumen, Objetivo(s), Summary, Professional Summary, Profile, Objective" }}.
              </li>
              <li>
                <strong>{{ is_en and "Work Experience" or "Experiencia laboral" }}</strong>
                → {{ is_en and "Professional Experience, Experience, Employment History, Career History" or "Experiencia profesional, Experiencia, Experience, Professional Experience, Work Experience, Employment History, Career History" }}.
              </li>
              <li>
                <strong>{{ is_en and "Education" or "Educación" }}</strong>
                → {{ is_en and "Academic Background" or "Formación académica, Education, Academic Background" }}.
              </li>
              <li>
                <strong>{{ is_en and "Skills" or "Habilidades" }}</strong>
                → {{ is_en and "Competencies, Hard/Soft/Technical Skills" or "Competencias, Skills, Hard Skills, Soft Skills, Technical Skills" }}.
              </li>
              <li>
                <strong>{{ is_en and "Languages" or "Idiomas" }}</strong>
              </li>
            </ul>

            <h6 class="mt-3">{{ t('star.title') }}</h6>
            <p class="small mb-1">{{ t('star.help')|safe }}</p>
            <ul class="small mb-0">
              <li>{{ t('star.s')|safe }}</li>
              <li>{{ t('star.t')|safe }}</li>
              <li>{{ t('star.a')|safe }}</li>
              <li>{{ t('star.r')|safe }}</li>
            </ul>

            {% if is_admin %}
              <div class="ms-3 mt-3">
                <label for="modelSelect" class="form-label fw-bold small mb-1">Select model</label>
                <select id="modelSelect" class="form-select form-select-sm" onchange="changeModel(this.value)">
                  <option value="auto"   {% if session.selected_model == 'auto' %}selected{% endif %}>Auto</option>
                  <option value="openai" {% if session.selected_model == 'openai' %}selected{% endif %}>OpenAI</option>
                  <option value="gemini" {% if session.selected_model == 'gemini' %}selected{% endif %}>Gemini</option>
                </select>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultado del análisis -->
  {% if feedback %}
    <h3 id="ai-analysis" class="visually-hidden">{{ t('analysis.title') }}</h3>

    {% if just_analyzed %}
      <script>
        window.addEventListener('load', function(){
          const el = document.getElementById('ai-analysis');
          if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        });
      </script>
    {% endif %}

    <div class="row g-4">
      <div class="col-12">
        {% set print_mode = False %}
        {% include "_analysis_block.html" %}
      </div>
    </div>
  {% endif %}

  <!-- Sugerencias (solo con sesión) -->
  {% if session.get('user_email') %}
    <div class="card mt-4 p-4 shadow-sm">
      <h4 class="mb-3">
        <i class="bi bi-chat-text"></i>
        {{ is_en and "Do you have suggestions to improve?" or "¿Tienes sugerencias para mejorar?" }}
      </h4>
      <form method="post" action="{{ url_for('main.leave_comment') }}">
        <div class="mb-2">
          <label class="form-label">{{ is_en and "Your comment" or "Tu comentario" }}</label>
          <textarea class="form-control" name="comment" rows="3" maxlength="2000" required></textarea>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted">{{ is_en and "Thanks for helping improve the service." or "Gracias por ayudar a mejorar el servicio." }}</div>
          <button class="btn btn-outline-primary">
            <i class="bi bi-send"></i> {{ is_en and "Send" or "Enviar" }}
          </button>
        </div>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script id="page-config" type="application/json">
{{ {
  "is_en": is_en,  
  "max_mb": (max_mb or 2),
  "txt_bad_ext": t('err.bad_ext'),
  "txt_too_big": t('err.too_big', max_mb=max_mb or 2),
  "txt_need_file": t('err.no_file'),
  "user_key": email or "anon" 
} | tojson }}
</script>

<script>
(function () {
  // === Carga de configuración desde JSON embebido ===
  const cfgEl = document.getElementById('page-config');
  const CFG = cfgEl
    ? JSON.parse(cfgEl.textContent)
    : { is_en:false, max_mb:2,
        txt_bad_ext:'Formato no permitido. Solo PDF o DOCX.',
        txt_too_big:'El archivo supera el límite.',
        txt_need_file:'Por favor, selecciona un archivo.' };

  const IS_EN       = !!CFG.is_en;
  const MAX_MB      = Number(CFG.max_mb) || 2;
  const TXT_BAD_EXT = CFG.txt_bad_ext || 'Formato no permitido. Solo PDF o DOCX.';
  const TXT_TOO_BIG = CFG.txt_too_big || ('El archivo supera el límite de ' + MAX_MB + ' MB.');
  const TXT_NEED_FILE = CFG.txt_need_file || 'Por favor, selecciona un archivo.';
  
  /* ===== 1) DONUTS ===== */
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  function ind(el){ return el.querySelector('.donut-indicator'); }
  function lbl(el){ return el.querySelector('.donut-label'); }
  function setColor(el, score){
    const color = (score >= 75) ? '#28a745' : (score >= 50 ? '#ffc107' : '#dc3545');
    ind(el).style.setProperty('--donut-color', color);
  }
  function setDash(el, val){ ind(el).style.setProperty('--dash', String(val)); }
  function setLabel(el, val){ const l = lbl(el); if (l) l.textContent = Math.round(val) + '%'; }
  function animateDonut(container, target, duration){
    const ioRed = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const to = Math.max(0, Math.min(100, parseInt(target || 0, 10)));
    if (!ind(container)) return;
    setColor(container, to);
    if (ioRed || duration <= 0) { setDash(container, to); setLabel(container, to); return; }
    const start = performance.now(); setDash(container, 0); setLabel(container, 0);
    function tick(now){
      const t = Math.min(1, (now - start) / duration);
      const val = to * easeOutCubic(t);
      setDash(container, val); setLabel(container, val);
      if (t < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }
  function initDonuts(){
    const donuts = document.querySelectorAll('.donut');
    if (!donuts.length) return;
    if (!('IntersectionObserver' in window)) {
      donuts.forEach(d => animateDonut(d, d.getAttribute('data-score') || 0, 900));
      return;
    }
    const io = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const el = entry.target;
        animateDonut(el, el.getAttribute('data-score') || 0, 900);
        io.unobserve(el);
      });
    }, { threshold: 0.25 });
    donuts.forEach(d => io.observe(d));
  }

  /* =========================================
   * 2) Uploader (click + drag&drop + limpiar)
   * ========================================= */
  function initUploader(){
    if (window.__cvms_uploader_inited) return;
    window.__cvms_uploader_inited = true;
    
    const dz = document.getElementById('dropzone');
    const fi = document.getElementById('file-input');
    const fn = document.getElementById('file-name');
    if (!dz || !fi || !fn) return;

    let isPicking = false; // <— candado

    const MAX_BYTES = MAX_MB * 1024 * 1024;

    const humanKB = bytes => Math.max(1, Math.round((bytes || 0) / 1024)) + ' KB';

    function clearVisual() {
      dz.classList.remove('ok','dragover','bg-success-subtle','border-success','bg-light');
      fn.classList.remove('text-success');
      fn.classList.add('text-secondary');
      fn.textContent = '';
    }

    function showOK(file) {
      fn.innerHTML =
        '<i class="bi bi-check-circle-fill me-1"></i> ' +
        (IS_EN ? 'File: ' : 'Archivo: ') + file.name + ' (' + humanKB(file.size) + ')';
      fn.classList.remove('text-secondary');
      fn.classList.add('text-success');
      dz.classList.add('ok','border-success','bg-success-subtle');
    }

    function validar(file) {
      if (!file) return false;
      if (!/\.(pdf|docx)$/i.test(file.name)) { alert(TXT_BAD_EXT); return false; }
      if (file.size > MAX_BYTES) { alert(TXT_TOO_BIG); return false; }
      return true;
    }

    // Helper para drag&drop -> input[type=file]
    function setFromDrop(file){
      if (!file) { fi.value = ''; clearVisual(); fi.dispatchEvent(new Event('change', {bubbles:true})); return; }
      if (!validar(file)) { fi.value = ''; clearVisual(); fi.dispatchEvent(new Event('change', {bubbles:true})); return; }
      try {
        const dt = new DataTransfer();
        dt.items.add(file);
        fi.files = dt.files; // puede fallar en navegadores viejos
      } catch(_) {}
      showOK(file);
      fi.dispatchEvent(new Event('change', {bubbles:true}));
    }

    // click en zona -> abre selector
    dz.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      if (isPicking) return;
      isPicking = true;
      try { fi.click(); } finally { /* nada */ }
    });

    // selector manual
    fi.addEventListener('change', function(e){
      isPicking = false; // resetea el candado
      const f = e.target.files && e.target.files[0];
      if (!f) { clearVisual(); return; }
      if (!validar(f)) { fi.value = ''; clearVisual(); return; }
      showOK(f);
    });

    // drag UI
    dz.addEventListener('dragover', function(e){ e.preventDefault(); dz.classList.add('dragover','bg-light'); });
    dz.addEventListener('dragenter', function(e){ e.preventDefault(); dz.classList.add('dragover','bg-light'); });
    dz.addEventListener('dragleave', function(){ dz.classList.remove('dragover','bg-light'); });
    dz.addEventListener('drop', function(e){
      e.preventDefault();
      dz.classList.remove('dragover','bg-light');
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      setFromDrop(f);
    });

    // Evita que soltar en la página reemplace el documento
    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => e.preventDefault());

    // Validación al enviar
    const frm = dz.closest('form');
    if (frm) {
      frm.addEventListener('submit', function(e){
        if (!fi.files || fi.files.length === 0) {
          e.preventDefault();
          alert(TXT_NEED_FILE);
        }
      });
    }

    // Botón "Limpiar archivo"
    const btnClearFile = document.getElementById('btn-clear-file');
    if (btnClearFile) {
      btnClearFile.addEventListener('click', function(){
        fi.value = '';
        clearVisual();
        fi.dispatchEvent(new Event('change', {bubbles:true}));
      });
    }
  }

  // Exporta/llama en tu boot
  // if (document.readyState === 'loading') {
  //   document.addEventListener('DOMContentLoaded', initUploader);
  // } else {
  //   initUploader();
  // }

  /* ===== 3) Tooltips ===== */
  function initTooltips(){
    const triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    triggers.forEach(el => { try { new bootstrap.Tooltip(el, { container: 'body', trigger: 'hover focus' }); } catch(_){} });
  }

  /* ===== 4) JD localStorage + limpiar + contador ===== */
  function initJobDesc(){
    const ta = document.getElementById('jobdesc');
    const btnClear = document.getElementById('btn-clear-jobdesc');
    const counter  = document.getElementById('char-count');
    if (!ta) return;

    const KEY = 'cvms_jobdesc_' + (CFG.user_key || 'anon');
    if (!ta.value.trim()) {
      const saved = localStorage.getItem(KEY);
      if (saved) ta.value = saved.slice(0, 4000);
    }
    function paintCount(){ if (counter) counter.textContent = ta.value.length + '/4000'; }
    ta.addEventListener('input', function(){
      if (ta.value.length > 4000) ta.value = ta.value.slice(0, 4000);
      try { localStorage.setItem(KEY, ta.value); } catch(e) {}
      paintCount();
      ta.dispatchEvent(new Event('cvms-jd-change', {bubbles:true}));
    });
    paintCount();
    ta.dispatchEvent(new Event('cvms-jd-change', {bubbles:true}));

    if (btnClear) {
      btnClear.addEventListener('click', function(){
        ta.value = '';
        paintCount();
        try { localStorage.removeItem(KEY); } catch(e) {}
        ta.dispatchEvent(new Event('input', {bubbles:true}));
        ta.focus();
      });
    }
    const frm = ta.closest('form');
    if (frm) {
      frm.addEventListener('submit', function(){
        try { localStorage.setItem(KEY, ta.value); } catch(e) {}
      });
    }
  }

  /* ===== 5) Badges 1-2-3 ===== */
  function initBadges(){
    const fi = document.getElementById('file-input');
    const ta = document.getElementById('jobdesc');
    const b1 = document.getElementById('badge-step1');
    const b2 = document.getElementById('badge-step2');
    const b3 = document.getElementById('badge-step3');
    if (!fi || !ta || !b1 || !b2 || !b3) return;

    const hasFile = () => !!(fi.files && fi.files.length > 0);
    const hasJD   = () => !!(ta.value && ta.value.trim().length > 0);

    function paint(){
      b1.classList.toggle('is-on', hasFile());
      b2.classList.toggle('is-on', hasJD());
      const ready = hasFile() && hasJD();
      b3.classList.toggle('is-ready', ready);
      if (!ready) b3.classList.remove('is-ready');
    }
    fi.addEventListener('change', paint);
    ta.addEventListener('input', paint);
    ta.addEventListener('cvms-jd-change', paint);
    paint();
  }

  /* BOOT */
  function boot(){
    initDonuts();
    initUploader();
    initTooltips();
    initJobDesc();
    initBadges();
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();

/* Scroll automático al análisis (compensa navbar fija) */
(function(){
  var el = document.getElementById('ai-analysis');
  if (!el) return;
  var prefersReduced = false;
  try { prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches; } catch(e){}
  var NAV_OFFSET = 80;
  var y = el.getBoundingClientRect().top + window.pageYOffset - NAV_OFFSET;
  window.scrollTo({ top: y, behavior: prefersReduced ? 'auto' : 'smooth' });
})();

/* Selector de modelo para Admin */
function changeModel(value) {
  fetch("{{ url_for('main.set_model') }}", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({model: value})
  })
  .then(r => r.json())
  .then(data => { console.log("Modelo cambiado a:", data.model); })
  .catch(err => console.error("Error cambiando modelo:", err));
}
</script>
{% endblock %}
