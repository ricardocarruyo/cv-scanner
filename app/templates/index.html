{% extends "base.html" %}
{% block title %}Inicio · CV Match Scanner{% endblock %}

{% block extra_head %}
<style>
  .gauge-wrap { position: relative; width: 100%; max-width: 460px; margin: 0 auto; aspect-ratio: 2 / 1; }
  .gauge { width: 100%; height: 100%; }
  .needle { transform-origin: 50% 100%; transition: transform 0.8s ease-in-out; }
  .score-label { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); font-size: 1.75rem; font-weight: 700; }
  .model-badge { font-size: .9rem; }

  .donut {
    --size: 150px;
    --track: #e9ecef;
    --ok: #28a745;
    --mid: #ffc107;
    --bad: #dc3545;
    width: var(--size);
    height: var(--size);
    border-radius: 50%;
    background:
      conic-gradient(var(--color, #28a745) 0deg, var(--color, #28a745) var(--angle, 0deg), var(--track) var(--angle, 0deg));
    position: relative;
    margin: 0 auto;
  }
  .donut::after{
    content: attr(data-score) '%';
    position:absolute; inset: 0;
    display:grid; place-items:center;
    font-weight: 700; color:#212529;
    background:
      radial-gradient(circle at center, #fff 0 58%, transparent 59%);
  }  

  .donut { cursor: help; }

  #dropzone { border-style: dashed; }

  #jobdesc {
    max-height: 220px;        /* límite para evitar que crezca infinito */
    overflow-y: auto;         /* solo scroll vertical */
    overflow-x: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Formulario -->
  <div class="col-12 col-lg-6">
    <div class="card p-4 shadow-sm h-100">
      {% if not session.get('user_email') %}
        <div class="text-center">
          <p class="mb-3">Para usar el analizador, primero inicia sesión con Google.</p>
          <a class="btn btn-outline-primary" href="{{ url_for('auth.login') }}">
            <i class="bi bi-google"></i> Iniciar sesión con Google
          </a>
        </div>
      {% else %}
        <form method="post" enctype="multipart/form-data" action="{{ url_for('main.index') }}">
          <div class="mb-3">
            <label class="form-label">Ocupación (opcional):</label>
            <input type="text" class="form-control" name="occupation" placeholder="Ej.: Analista de Negocio, QA, DevOps" value="{{ occupation or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label">Sube tu CV (PDF o DOCX, máx. {{ max_mb or 2 }} MB):</label>

            <input id="file-input" type="file" name="cv" accept=".pdf,.docx" hidden required>

            <div id="dropzone" class="border border-2 rounded-3 p-4 text-center bg-white"
                style="cursor:pointer; border-style:dashed;">
              <div class="mb-2 fw-semibold">Arrastra y suelta tu archivo aquí</div>
              <div class="text-muted small">o haz clic para elegir desde tu computadora</div>
              <div id="file-name" class="mt-2 small text-secondary"></div>
            </div>

            <div class="form-text">Solo PDF/DOCX. Realizamos controles básicos de seguridad.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Pega la descripción del puesto:</label>

            <textarea id="jobdesc" name="jobdesc"
                      class="form-control"
                      rows="8"
                      maxlength="4000"
                      required
                      style="overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word; max-height: 220px;">{{ jobdesc or '' }}</textarea>

            <div class="d-flex justify-content-between align-items-center mt-1">
              <button type="button" id="btn-clear-jobdesc" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-eraser"></i> Limpiar
              </button>

              <!-- El contador VA DENTRO del form y con un id único -->
              <span id="char-count" class="small text-muted">0/4000</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Analizar</button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- Panel derecho -->
  <div class="col-12 col-lg-6">
    <div class="card p-4 shadow-sm h-100 d-flex align-items-stretch">
      {% if score_jd is not none and score_ats is not none %}
        <div class="row w-100 text-center">
          <div class="col-6 mb-3">
            <div
              class="donut"
              data-score="{{ score_jd|int }}"
              data-bs-toggle="tooltip"
              data-bs-html="true"
              title="
                <strong>Coincidencia con la Job Description</strong><br>
                Compara tu CV con la descripción del puesto usando
                {% if model_used == 1 %}OpenAI GPT-4o{% elif model_used == 2 %}Gemini 1.5 Flash{% else %}el modelo seleccionado{% endif %}.<br>
                <em>Consejo:</em> apunta a ≥ 70%.
              ">
            </div>
            <div class="fw-semibold mt-2">Coincidencia JD</div>
          </div>

          <div class="col-6 mb-3">
            <div
              class="donut"
              data-score="{{ score_ats|int }}"
              data-bs-toggle="tooltip"
              data-bs-html="true"
              title="
                <strong>Estructura ATS del CV</strong><br>
                Secciones detectadas: {{ ats_details.sections_found if ats_details else 0 }}/5<br>
                Páginas: {{ ats_details.pages if ats_details else '-' }}{% if ats_details %} {% if ats_details.pages <= 2 %}(OK){% elif ats_details.pages == 3 %}(justo){% else %}(exceso){% endif %}{% endif %}<br>
                Imágenes: {{ ats_details.images if ats_details else 0 }} (evítalas)<br>
                Tablas: {{ ats_details.tables if ats_details else 0 }} (evítalas)<br>
                Idioma CV: {% if ats_details and ats_details.lang_ok %}Inglés{% else %}Español/otro{% endif %}.
              ">
            </div>
            <div class="fw-semibold mt-2">Coincidencia Plantilla ATS</div>
          </div>
        </div>
      {% else %}
        <div class="w-100">
          <h5 class="mb-3">Lineamientos para subir tu CV</h5>
          <ul class="small mb-3">
            <li>Formato: <strong>PDF o DOCX</strong></li>
            <li>Idioma: <strong>Español o Inglés</strong></li>
            <li>Texto legible (no imagen escaneada)</li>
            <li>Tamaño máximo: <strong>{{ max_mb }} MB</strong></li>
            <li>Solo el CV (no adjuntes otros documentos)</li>
            <li>
              <a class="link-primary" href="{{ url_for('static', filename='docs/Plantilla_CV_ATS_STAR.docx') }}" download>
                Descargar Plantilla CV ATS
              </a>
            </li>
          </ul>

          <h6 class="mt-3">Recomendaciones ATS</h6>
          <ul class="small">
            <li><strong>1–2 páginas</strong> (junior 1 pág., senior hasta 2).</li>
            <li>Tipografías seguras: Arial, Calibri, Helvetica, Verdana.</li>
            <li><strong>Evita</strong> imágenes, logos, tablas y columnas.</li>
            <li>Usa encabezados simples (H1/H2) y bullets estándar.</li>
            <li>No uses gráficos incrustados ni íconos como texto.</li>
          </ul>

          <h6 class="mt-3">Títulos / Secciones equivalentes aceptadas por ATS</h6>
          <p class="small text-muted mb-2">Puedes usar cualquiera de estos nombres; el sistema los reconocerá como equivalentes.</p>
          <ul class="small mb-3">
            <li>
              <strong>Perfil profesional</strong> → Resumen profesional, Resumen, Objetivo(s), <em>Summary</em>, <em>Professional Summary</em>, <em>Profile</em>, <em>Objective</em>.
            </li>
            <li>
              <strong>Experiencia laboral</strong> → Experiencia profesional, Experiencia, <em>Work Experience</em>, <em>Employment History</em>, <em>Career History</em>.
            </li>
            <li>
              <strong>Educación</strong> → Formación académica, <em>Education</em>, <em>Academic Background</em>.
            </li>
            <li>
              <strong>Habilidades</strong> → Competencias, <em>Skills</em>, <em>Hard Skills</em>, <em>Soft Skills</em>, <em>Technical Skills</em>.
            </li>
            <li>
              <strong>Idiomas</strong> → <em>Languages</em>.
            </li>
          </ul>

          <h6 class="mt-3">Recomendación: usa el formato STAR en tu experiencia</h6>
          <p class="small mb-1">
            El método <strong>STAR</strong> ayuda a redactar logros claros y medibles:
          </p>
          <ul class="small mb-0">
            <li><strong>S</strong>ituación: contexto o problema.</li>
            <li><strong>T</strong>area: objetivo o responsabilidad.</li>
            <li><strong>A</strong>cción: qué hiciste específicamente.</li>
            <li><strong>R</strong>esultado: impacto medible (%, tiempos, ahorros, etc.).</li>
          </ul>
        </div>
      {% endif %}
    </div>
  </div>

<!-- Resultado del análisis -->
{% if feedback %}
  <div class="card mt-4 p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="mb-0">Análisis de la IA</h3>
      <div class="d-flex gap-2">
        {% if model_used == 1 %}
          <span class="badge text-bg-primary model-badge"><i class="bi bi-cpu"></i> Modelo 1: OpenAI</span>
        {% elif model_used == 2 %}
          <span class="badge text-bg-success model-badge"><i class="bi bi-stars"></i> Modelo 2: Gemini</span>
        {% endif %}
        {% if exec_id %}
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('history.download_pdf', exec_id=exec_id) }}"><i class="bi bi-file-earmark-arrow-down"></i> Descargar PDF</a>
        {% endif %}
      </div>
    </div>
    <div>{{ feedback|safe }}</div>
    <hr class="my-4">
    <h5 class="mb-2">Estructura ATS detectada</h5>
    <div class="row">
      <div class="col-md-6">
        <div class="fw-semibold">Secciones presentes ({{ ats_details.sections_found if ats_details else 0 }}/5)</div>
        <ul class="small mb-3">
          {% if ats_details and ats_details.sections_present %}
            {% for s in ats_details.sections_present %}
              <li>{{ s|title }}</li>
            {% endfor %}
          {% else %}
            <li class="text-muted">No detectadas.</li>
          {% endif %}
        </ul>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Secciones faltantes</div>
        <ul class="small mb-0">
          {% if ats_details and ats_details.sections_missing %}
            {% for s in ats_details.sections_missing %}
              <li>{{ s|title }}</li>
            {% endfor %}
          {% else %}
            <li class="text-muted">Ninguna.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <hr class="my-4">
      <h5 class="mb-2">Lineamientos y equivalencias ATS</h5>
      <ul class="small mb-2">
        <li>Formato: <strong>PDF o DOCX</strong>. Idioma: <strong>Español o Inglés</strong>. Texto legible (no escaneado). Máx. {{ max_mb }} MB.</li>
        <li>Evita imágenes, tablas y columnas; usa encabezados simples y bullets estándar.</li>
        <li>Tipografías seguras: Arial, Calibri, Helvetica, Verdana.</li>
        <li>
          <a class="link-primary" href="{{ url_for('static', filename='docs/Plantilla_CV_ATS_STAR.docx') }}" download>
            Descargar Plantilla CV ATS
          </a>
        </li>
      </ul>

      <div class="row">
        <div class="col-md-6">
          <div class="fw-semibold small">Secciones equivalentes aceptadas</div>
          <ul class="small mb-3">
            <li><strong>Perfil profesional</strong> → Resumen profesional, Resumen, Objetivo(s), <em>Summary</em>, <em>Professional Summary</em>, <em>Profile</em>, <em>Objective</em>.</li>
            <li><strong>Experiencia laboral</strong> → Experiencia profesional, Experiencia, <em>Work Experience</em>, <em>Employment History</em>, <em>Career History</em>.</li>
            <li><strong>Educación</strong> → Formación académica, <em>Education</em>, <em>Academic Background</em>.</li>
            <li><strong>Habilidades</strong> → Competencias, <em>Skills</em>, <em>Hard/Soft/Technical Skills</em>.</li>
            <li><strong>Idiomas</strong> → <em>Languages</em>.</li>
          </ul>
        </div>
        <div class="col-md-6">
          <div class="fw-semibold small">Formato STAR para tu experiencia</div>
          <p class="small mb-1">Redacta cada logro con STAR para mejorar la lectura por ATS y por reclutadores:</p>
          <ul class="small mb-0">
            <li><strong>S</strong>ituación: contexto o problema.</li>
            <li><strong>T</strong>area: objetivo o responsabilidad.</li>
            <li><strong>A</strong>cción: qué hiciste específicamente (verbos de acción, métricas, herramientas).</li>
            <li><strong>R</strong>esultado: impacto cuantificable (% mejora, tiempos, costos, calidad).</li>
          </ul>
        </div>
      </div>
  </div>
{% endif %}

<!-- Sugerencias (solo con sesión) -->
{% if session.get('user_email') %}
  <div class="card mt-4 p-4 shadow-sm">
    <h4 class="mb-3"><i class="bi bi-chat-text"></i> ¿Tienes sugerencias para mejorar?</h4>
    <form method="post" action="{{ url_for('main.leave_comment') }}">
      <div class="mb-2">
        <label class="form-label">Tu comentario</label>
        <textarea class="form-control" name="comment" rows="3" maxlength="2000" required></textarea>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">Gracias por ayudar a mejorar el servicio.</div>
        <button class="btn btn-outline-primary"><i class="bi bi-send"></i> Enviar</button>
      </div>
    </form>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function () {
  // --- Donuts (si los usas) ---
  var donuts = document.querySelectorAll('.donut');
  donuts.forEach(function(el){
    var s = parseInt(el.getAttribute('data-score') || '0', 10);
    s = Math.max(0, Math.min(100, s));
    var deg = s * 3.6;
    var color = (s >= 80) ? '#28a745' : (s >= 50 ? '#ffc107' : '#dc3545');
    el.style.setProperty('--angle', deg + 'deg');
    el.style.setProperty('--color', color);
  });

  // --- Drag & Drop / File input ---
  var dz = document.getElementById('dropzone');
  var fi = document.getElementById('file-input');
  var fn = document.getElementById('file-name');
  if (!dz || !fi) return;

  function humanKB(bytes){ return Math.round((bytes||0)/1024) + ' KB'; }

  function showName(file){
    if (!file) {
      fn.textContent = '';
      clearOK();
      return;
    }
    // texto en verde + check
    fn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> ' +
                   'Archivo: ' + file.name + ' (' + humanKB(file.size) + ')';
    fn.classList.remove('text-secondary');
    fn.classList.add('text-success');

    // resalta el recuadro en verde suave
    dz.classList.add('border-success','bg-success-subtle');
  }

  function validarExt(file){
    if (!/\.(pdf|docx)$/i.test(file.name)) {
      alert('Formato no permitido. Solo PDF o DOCX.');
      return false;
    }
    return true;
  }

  // Asigna un archivo al input usando DataTransfer (camino “drop”)
  function setFileFromDrop(file){
    if (!file || !validarExt(file)) return;
    try {
      var dt = new DataTransfer();
      dt.items.add(file);
      fi.files = dt.files;          // ✅ asignamos FileList válido
      showName(file);
    } catch (e) {
      console.warn('No se pudo asignar el archivo vía DataTransfer', e);
      // Fallback: muestra el nombre y pide que elija por click
      showName(file);
      alert('Tu navegador no permite asignar el archivo automáticamente. Haz clic para seleccionarlo.');
    }
  }

  // Click en zona -> abre selector nativo
  dz.addEventListener('click', function(){ fi.click(); });

  // Selector manual: NO reasignamos fi.files, solo validamos y mostramos
  fi.addEventListener('change', function(e){
    var f = e.target.files && e.target.files[0];
    if (!f) { showName(null); return; }
    if (!validarExt(f)) { fi.value = ''; showName(null); return; }
    showName(f);
  });

  // Efectos visuales de drag
  dz.addEventListener('dragover', function(e){ e.preventDefault(); dz.classList.add('bg-light'); });
  dz.addEventListener('dragleave', function(){ dz.classList.remove('bg-light'); });

  // Drop
  dz.addEventListener('drop', function(e){
    e.preventDefault();
    dz.classList.remove('bg-light');
    var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    setFileFromDrop(f);
  });

  // Validación antes de enviar (por si quedó sin archivo)
  var frm = dz.closest('form');
  if (frm) {
    frm.addEventListener('submit', function(e){
      if (!fi.files || fi.files.length === 0) {
        e.preventDefault();
        alert('Por favor, selecciona un archivo PDF o DOCX.');
      }
    });
  }
})();

(function () {
  // Inicializar tooltips Bootstrap
  var triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  triggers.forEach(function (el) {
    new bootstrap.Tooltip(el, { container: 'body', trigger: 'hover focus' });
  });
})();

(function(){
  var ta = document.getElementById('jobdesc');
  var btnClear = document.getElementById('btn-clear-jobdesc');
  if (!ta) return;

  var KEY = 'cvms_jobdesc';

  // 1) Inicializa desde localStorage si el servidor no trajo contenido
  // (Si el servidor pintó `{{ jobdesc }}`, lo respetamos)
  if (!ta.value.trim()) {
    var saved = localStorage.getItem(KEY);
    if (saved) ta.value = saved;
  }

  // 2) Guarda en localStorage en tiempo real
  ta.addEventListener('input', function(){
    try { localStorage.setItem(KEY, ta.value); } catch(e) {}
  });

  // 3) Botón limpiar: borra textarea y storage
  if (btnClear) {
    btnClear.addEventListener('click', function(){
      ta.value = '';
      try { localStorage.removeItem(KEY); } catch(e) {}
      ta.focus();
    });
  }

  // 4) (Opcional) Antes de enviar, aseguramos guardar lo último
  var frm = ta.closest('form');
  if (frm) {
    frm.addEventListener('submit', function(){
      try { localStorage.setItem(KEY, ta.value); } catch(e) {}
    });
  }
})();

(function () {
  var ta = document.getElementById('jobdesc');
  var counter = document.getElementById('char-count');
  if (!ta || !counter) return;

  function updateCount() {
    counter.textContent = (ta.value.length) + "/4000";
  }

  // Inicializa con el valor actual (incluyendo si lo cargó localStorage o el servidor)
  updateCount();

  // Actualiza mientras escribe
  ta.addEventListener('input', updateCount);
})();
</script>
{% endblock %}





