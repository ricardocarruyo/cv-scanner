{% extends "base.html" %}
{% block title %}Inicio · CV Match Scanner{% endblock %}

{% block extra_head %}
<style>
  .gauge-wrap { position: relative; width: 100%; max-width: 460px; margin: 0 auto; aspect-ratio: 2 / 1; }
  .gauge { width: 100%; height: 100%; }
  .needle { transform-origin: 50% 100%; transition: transform 0.8s ease-in-out; }
  .score-label { position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%); font-size: 1.75rem; font-weight: 700; }
  .model-badge { font-size: .9rem; }

  /* Contenedor que hospeda cada donut dentro de la grilla */
  .analysis-meters .donut-host {
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;    /* <- importante para que no recorte el contenedor */
    min-height: 160px;
  }

  .donut-wrap   { position: relative; width: 180px; height: 180px; }
  .donut-svg    { width: 100%; height: 100%; transform: rotate(-90deg); }

  .donut-track {
    fill: none;
    stroke: #eee;
    stroke-width: 4.5;    /* antes 6 */
  }

  .donut-indicator {
    fill: none;
    stroke: var(--donut-color, #28a745);
    stroke-width: 4.5;    /* antes 6 */
    stroke-linecap: round;
    stroke-dasharray: var(--dash, 0) 100;
    transition: stroke-dasharray .6s ease, stroke .3s ease;
  }

  .donut-label {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 1.1rem;
  }

  @media (max-width: 991.98px) {
    .analysis-meters .donut-host { min-height: 200px; }
    .donut-wrap { width: 160px; height: 160px; }
  } 

  #dropzone { border-style: dashed; }
  .dropzone.dragover { background-color:#f8f9fa; border-color:#0d6efd; }
  .dropzone.ok { border-color:#198754; background: var(--bs-success-bg-subtle, #eaf6ed); }

  #jobdesc {
    max-height: 160px;        /* límite para evitar que crezca infinito */
    overflow-y: auto;         /* solo scroll vertical */
    overflow-x: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
  }  

  /* Indicadores circulares 1–2–3 */
  .badge-circle{
    --on-bg: #0d6efd;       /* azul encendido */
    --off-bg:#e9ecef;       /* gris apagado  */
    --on-fg:#fff;
    --off-fg:#6c757d;

    width: 32px; height: 32px; border-radius: 50%;
    display: inline-grid; place-items: center;
    font-weight: 700; font-size: .95rem;
    background: var(--off-bg); color: var(--off-fg);
    border: 2px solid #dee2e6;
    transition: background .2s ease, color .2s ease, box-shadow .2s ease;
    box-shadow: 0 0 0 0 rgba(13,110,253,0);
    line-height: 1;
  }
  .badge-circle.is-on{
    background: var(--on-bg); color: var(--on-fg); border-color: var(--on-bg);
    box-shadow: 0 0 0 4px rgba(13,110,253,.15);
  }

  /* Parpadeo suave cuando ③ está listo */
  @keyframes pulse {
    0%   { transform: scale(1);   box-shadow: 0 0 0 0 rgba(13,110,253,.35); }
    70%  { transform: scale(1.06); box-shadow: 0 0 0 10px rgba(13,110,253,0); }
    100% { transform: scale(1);   box-shadow: 0 0 0 0 rgba(13,110,253,0); }
  }
  .badge-circle.is-ready{
    background:#28a745; border-color:#28a745; /* verde “listo” */
    color:#fff;
    animation: pulse 1.4s ease-in-out infinite;
  }

  /* Pequeños ajustes de alineación en labels/botón */
  .label-with-badge{ display:flex; align-items:center; gap:.5rem; }
  .before-button{ display:flex; align-items:center; gap:.5rem; }

</style>
{% endblock %}

{% block content %}
  <!-- Paneles izq. y der. -->
  <div class="container mt-3">
    <div class="row g-4 mb-4 equal-panels">
      <!-- IZQUIERDA: FORM -->
      <div class="col-12 col-lg-6">
        <div class="card p-4 shadow-sm h-100">
          {% if not session.get('user_email') %}
            <div class="text-center">
              <p class="mb-3">Para usar el analizador, primero inicia sesión con Google.</p>
              <a class="btn btn-outline-primary" href="{{ url_for('auth.login') }}">
                <i class="bi bi-google"></i> Iniciar sesión con Google
              </a>
            </div>
          {% else %}
            <form method="post" enctype="multipart/form-data" action="{{ url_for('main.index') }}">
              
            <!--   <div class="mb-3">
                <label class="form-label">Ocupación (opcional):</label>
                <input type="text" class="form-control" name="occupation"
                      placeholder="Ej.: Analista de Negocio, QA, DevOps"
                      value="{{ occupation or '' }}">
              </div> -->

              <div class="w-100">
                <h5 class="mb-3">Lineamientos para subir tu CV</h5>
                <ul class="small mb-3">
                  <li>Formato: <strong>PDF o DOCX</strong></li>
                  <li>Idioma: <strong>Español o Inglés</strong></li>
                  <li>Texto legible (no imagen escaneada)</li>
                  <li>Tamaño máximo: <strong>{{ max_mb }} MB</strong></li>
                  <li>Solo el CV (no adjuntes otros documentos)</li>
                  <li>
                    <a class="link-primary" href="{{ url_for('static', filename='docs/Plantilla_CV_ATS_STAR.docx') }}" download>
                      Descargar Plantilla CV ATS
                    </a>
                  </li>
                </ul>
              </div>

              <div class="mb-2">
                <label class="form-label label-with-badge">
                  <span id="badge-step1" class="badge-circle">1</span>
                  Sube tu CV (PDF o DOCX, máx. {{ max_mb or 2 }} MB):
                </label>

                <!-- input real (oculto) -->
                <input id="file-input" name="cv" type="file" accept=".pdf,.docx" class="visually-hidden">

                <!-- zona drag&drop -->
                <div id="dropzone"
                    class="dropzone border border-2 rounded-3 p-4 text-center bg-white"
                    style="border-style:dashed; cursor:pointer;">
                  <div class="fw-semibold">Arrastra y suelta tu archivo aquí</div>
                  <div class="text-muted small">o haz clic para elegir desde tu computadora</div>
                  <div id="file-name" class="small mt-2 text-secondary"></div>
                </div>

                 <div class="d-flex justify-content-between align-items-center mt-1">
                  <button type="button" id="btn-clear-file" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eraser"></i> Limpiar archivo
                  </button>                  
                </div>

                <div class="form-text">Solo PDF/DOCX. Realizamos controles básicos de seguridad.</div>
              </div>

              <!-- Job Description -->
              <div class="mb-3">
                <label class="form-label label-with-badge">
                  <span id="badge-step2" class="badge-circle">2</span>
                  Pega la descripción del puesto:
                </label>

                <textarea id="jobdesc" name="jobdesc"
                          class="form-control"
                          rows="8"
                          maxlength="4000"
                          required
                          style="overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word; max-height:160px;">{{ jobdesc or '' }}</textarea>

                <div class="d-flex justify-content-between align-items-center mt-1">
                  <button type="button" id="btn-clear-jobdesc" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eraser"></i> Limpiar
                  </button>
                  <span id="char-count" class="small text-muted">0/4000</span>
                </div>
              </div>

              <!-- Botón + indicador ③ al costado -->
              <div class="before-button">
                <span id="badge-step3" class="badge-circle">3</span>
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-search"></i> Analizar
                </button>
              </div>
            </form>
          {% endif %}
        </div>
      </div>

      <!-- DERECHA: LINEAMIENTOS -->
      <div class="col-12 col-lg-6">
        <div class="card p-4 shadow-sm h-100 d-flex align-items-stretch">
          <!-- tu bloque de lineamientos tal como lo tienes -->
          <div class="w-100">
      <!--       <h5 class="mb-3">Lineamientos para subir tu CV</h5>
            <ul class="small mb-3">
              <li>Formato: <strong>PDF o DOCX</strong></li>
              <li>Idioma: <strong>Español o Inglés</strong></li>
              <li>Texto legible (no imagen escaneada)</li>
              <li>Tamaño máximo: <strong>{{ max_mb }} MB</strong></li>
              <li>Solo el CV (no adjuntes otros documentos)</li>
              <li>
                <a class="link-primary" href="{{ url_for('static', filename='docs/Plantilla_CV_ATS_STAR.docx') }}" download>
                  Descargar Plantilla CV ATS
                </a>
              </li>
            </ul> -->

            <h5 class="mb-3">Recomendaciones ATS</h5>
            <ul class="small">
              <li><strong>1–2 páginas</strong> (junior 1 pág., senior hasta 2).</li>
              <li>Tipografías seguras: Arial, Calibri, Helvetica, Verdana.</li>
              <li><strong>Evita</strong> imágenes, logos, tablas y columnas.</li>
              <li>Usa encabezados simples (H1/H2) y bullets estándar.</li>
              <li>No uses gráficos incrustados ni íconos como texto.</li>
            </ul>

            <h6 class="mt-3">Títulos / Secciones equivalentes aceptadas por ATS</h6>
            <p class="small text-muted mb-2">Puedes usar cualquiera de estos nombres; el sistema los reconocerá como equivalentes.</p>
            <ul class="small mb-3">
              <li>
                <strong>Perfil profesional</strong> → Resumen profesional, Resumen, Objetivo(s), <em>Summary</em>, <em>Professional Summary</em>, <em>Profile</em>, <em>Objective</em>.
              </li>
              <li>
                <strong>Experiencia laboral</strong> → Experiencia profesional, Experiencia, <em>Experience</em>, <em>Professional Experience</em>, <em>Work Experience</em>, <em>Employment History</em>, <em>Career History</em>.
              </li>
              <li>
                <strong>Educación</strong> → Formación académica, <em>Education</em>, <em>Academic Background</em>.
              </li>
              <li>
                <strong>Habilidades</strong> → Competencias, <em>Skills</em>, <em>Hard Skills</em>, <em>Soft Skills</em>, <em>Technical Skills</em>.
              </li>
              <li>
                <strong>Idiomas</strong> → <em>Languages</em>.
              </li>
            </ul>

            <h6 class="mt-3">Recomendación: usa el formato STAR en tu experiencia</h6>
            <p class="small mb-1">
              El método <strong>STAR</strong> ayuda a redactar logros claros y medibles:
            </p>
            <ul class="small mb-0">
              <li><strong>S</strong>ituación: contexto o problema.</li>
              <li><strong>T</strong>area: objetivo o responsabilidad.</li>
              <li><strong>A</strong>cción: qué hiciste específicamente.</li>
              <li><strong>R</strong>esultado: impacto medible (%, tiempos, ahorros, etc.).</li>
            </ul>
          </div> 
        </div>
      </div>
    </div>
  </div>

  <!-- Resultado del análisis -->
  {% if feedback %}
    {# solo marca que NO estamos en modo impresión #}
    {# Ancla #}
    <h3 id="ai-analysis" class="visually-hidden">Análisis</h3>
    
    {% if just_analyzed %}
      <script>
        window.addEventListener('load', function(){
          const el = document.getElementById('ai-analysis');
          if(el){ el.scrollIntoView({behavior:'smooth', block:'start'}); }
        });
      </script>
    {% endif %}
    </div> 
    
    <!-- Analisis -->
    {% if feedback %}
      <div class="row g-4">
        <div class="col-12">
          {# si usas el partial #}
          {% set print_mode = False %}
          {% include "_analysis_block.html" %}
        </div>
      </div>
    {% endif %}

  {% endif %}

  <!-- Sugerencias (solo con sesión) -->
  {% if session.get('user_email') %}
    <div class="card mt-4 p-4 shadow-sm">
      <h4 class="mb-3"><i class="bi bi-chat-text"></i> ¿Tienes sugerencias para mejorar?</h4>
      <form method="post" action="{{ url_for('main.leave_comment') }}">
        <div class="mb-2">
          <label class="form-label">Tu comentario</label>
          <textarea class="form-control" name="comment" rows="3" maxlength="2000" required></textarea>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted">Gracias por ayudar a mejorar el servicio.</div>
          <button class="btn btn-outline-primary"><i class="bi bi-send"></i> Enviar</button>
        </div>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function () {
  /* ===========================
   * 1) DONUTS (animación + color)
   * =========================== */
  function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
  function ind(el){ return el.querySelector('.donut-indicator'); }
  function lbl(el){ return el.querySelector('.donut-label'); }

  function setColor(el, score){
    const color = (score >= 75) ? '#28a745' : (score >= 50 ? '#ffc107' : '#dc3545');
    ind(el).style.setProperty('--donut-color', color);
  }
  function setDash(el, val){ ind(el).style.setProperty('--dash', String(val)); }
  function setLabel(el, val){ const l = lbl(el); if (l) l.textContent = Math.round(val) + '%'; }

  function animateDonut(container, target, duration){
    const ioRed = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const to = Math.max(0, Math.min(100, parseInt(target || 0, 10)));
    if (!ind(container)) return;
    setColor(container, to);

    if (ioRed || duration <= 0) {
      setDash(container, to); setLabel(container, to); return;
    }
    const start = performance.now();
    setDash(container, 0); setLabel(container, 0);

    function tick(now){
      const t = Math.min(1, (now - start) / duration);
      const val = to * easeOutCubic(t);
      setDash(container, val); setLabel(container, val);
      if (t < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function initDonuts(){
    const donuts = document.querySelectorAll('.donut');
    if (!donuts.length) return;

    if (!('IntersectionObserver' in window)) {
      donuts.forEach(d => animateDonut(d, d.getAttribute('data-score') || 0, 900));
      return;
    }
    const io = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        const el = entry.target;
        animateDonut(el, el.getAttribute('data-score') || 0, 900);
        io.unobserve(el);
      });
    }, { threshold: 0.25 });

    donuts.forEach(d => io.observe(d));
  }

  /* =========================================
   * 2) Uploader (click + drag&drop + limpiar)
   * ========================================= */
  function initUploader(){
    const dz = document.getElementById('dropzone');
    const fi = document.getElementById('file-input');
    const fn = document.getElementById('file-name');
    if (!dz || !fi || !fn) return;

    const MAX_MB = 2;
    const MAX_BYTES = MAX_MB * 1024 * 1024;

    const humanKB = bytes => Math.max(1, Math.round((bytes || 0) / 1024)) + ' KB';

    function clearVisual() {
      dz.classList.remove('ok','dragover','bg-success-subtle','border-success','bg-light');
      fn.classList.remove('text-success');
      fn.classList.add('text-secondary');
      fn.textContent = '';
    }

    function showOK(file) {
      fn.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i> ' +
                     'Archivo: ' + file.name + ' (' + humanKB(file.size) + ')';
      fn.classList.remove('text-secondary');
      fn.classList.add('text-success');
      dz.classList.add('ok','border-success','bg-success-subtle');
    }

    function validar(file) {
      if (!file) return false;
      if (!/\.(pdf|docx)$/i.test(file.name)) { alert('Formato no permitido. Solo PDF o DOCX.'); return false; }
      if (file.size > MAX_BYTES) { alert('El archivo supera el límite de ' + MAX_MB + ' MB.'); return false; }
      return true;
    }

    // Helper para drag&drop -> input[type=file]
    function setFromDrop(file){
      if (!file) { fi.value = ''; clearVisual(); fi.dispatchEvent(new Event('change', {bubbles:true})); return; }
      if (!validar(file)) { fi.value = ''; clearVisual(); fi.dispatchEvent(new Event('change', {bubbles:true})); return; }

      try {
        const dt = new DataTransfer();
        dt.items.add(file);
        fi.files = dt.files; // puede fallar en navegadores viejos
      } catch(_) {
        // fallback: no podemos asignar files; al menos mostramos OK visual
      }
      showOK(file);
      // avisamos a cualquier listener (badges)
      fi.dispatchEvent(new Event('change', {bubbles:true}));
    }

    // click en zona -> abre selector
    dz.addEventListener('click', function(e){ e.preventDefault(); fi.click(); });

    // selector manual
    fi.addEventListener('change', function(e){
      const f = e.target.files && e.target.files[0];
      if (!f) { clearVisual(); return; }
      if (!validar(f)) { fi.value = ''; clearVisual(); return; }
      showOK(f);
    });

    // drag UI
    dz.addEventListener('dragover', function(e){ e.preventDefault(); dz.classList.add('dragover','bg-light'); });
    dz.addEventListener('dragenter', function(e){ e.preventDefault(); dz.classList.add('dragover','bg-light'); });
    dz.addEventListener('dragleave', function(){ dz.classList.remove('dragover','bg-light'); });
    dz.addEventListener('drop', function(e){
      e.preventDefault();
      dz.classList.remove('dragover','bg-light');
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      setFromDrop(f);
    });

    // Evita que soltar en la página reemplace el documento
    window.addEventListener('dragover', e => e.preventDefault());
    window.addEventListener('drop', e => e.preventDefault());

    // Validación al enviar
    const frm = dz.closest('form');
    if (frm) {
      frm.addEventListener('submit', function(e){
        if (!fi.files || fi.files.length === 0) {
          e.preventDefault();
          alert('Por favor, selecciona un archivo PDF o DOCX.');
        }
      });
    }

    // Botón "Limpiar archivo"
    const btnClearFile = document.getElementById('btn-clear-file');
    if (btnClearFile) {
      btnClearFile.addEventListener('click', function(){
        fi.value = '';
        clearVisual();
        // importante: notificar para apagar el badge 1 y 3
        fi.dispatchEvent(new Event('change', {bubbles:true}));
      });
    }
  }

  /* ==============================
   * 3) Tooltips (Bootstrap)
   * ============================== */
  function initTooltips(){
    const triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    triggers.forEach(el => { try { new bootstrap.Tooltip(el, { container: 'body', trigger: 'hover focus' }); } catch(_){} });
  }

  /* ======================================================
   * 4) JD: localStorage + limpiar + contador + eventos
   * ====================================================== */
  function initJobDesc(){
    const ta = document.getElementById('jobdesc');
    const btnClear = document.getElementById('btn-clear-jobdesc');
    const counter  = document.getElementById('char-count');
    if (!ta) return;

    const KEY = 'cvms_jobdesc';

    // inicializa desde localStorage si el servidor no trajo contenido
    if (!ta.value.trim()) {
      const saved = localStorage.getItem(KEY);
      if (saved) ta.value = saved.slice(0, 4000);
    }

    function paintCount(){ if (counter) counter.textContent = ta.value.length + '/4000'; }

    // guarda en tiempo real
    ta.addEventListener('input', function(){
      if (ta.value.length > 4000) ta.value = ta.value.slice(0, 4000);
      try { localStorage.setItem(KEY, ta.value); } catch(e) {}
      paintCount();
      // evento custom para otros módulos
      ta.dispatchEvent(new Event('cvms-jd-change', {bubbles:true}));
    });

    // contador inicial + evento para badges (por si vino del localStorage)
    paintCount();
    ta.dispatchEvent(new Event('cvms-jd-change', {bubbles:true}));

    // botón limpiar
    if (btnClear) {
      btnClear.addEventListener('click', function(){
        ta.value = '';
        paintCount();
        try { localStorage.removeItem(KEY); } catch(e) {}
        // notificar a badges para apagar el paso 2 y 3
        ta.dispatchEvent(new Event('input', {bubbles:true}));
        ta.focus();
      });
    }

    // asegura persistencia justo antes del submit
    const frm = ta.closest('form');
    if (frm) {
      frm.addEventListener('submit', function(){
        try { localStorage.setItem(KEY, ta.value); } catch(e) {}
      });
    }
  }

  /* ==========================
   * 5) Badges ① ② ③
   * ========================== */
  function initBadges(){
    const fi = document.getElementById('file-input');
    const ta = document.getElementById('jobdesc');

    const b1 = document.getElementById('badge-step1');
    const b2 = document.getElementById('badge-step2');
    const b3 = document.getElementById('badge-step3');

    if (!fi || !ta || !b1 || !b2 || !b3) return;

    const hasFile = () => !!(fi.files && fi.files.length > 0);
    const hasJD   = () => !!(ta.value && ta.value.trim().length > 0);

    function paint(){
      b1.classList.toggle('is-on', hasFile());
      b2.classList.toggle('is-on', hasJD());

      const ready = hasFile() && hasJD();
      b3.classList.toggle('is-ready', ready);
      if (!ready) b3.classList.remove('is-ready');
    }

    fi.addEventListener('change', paint);
    ta.addEventListener('input', paint);
    ta.addEventListener('cvms-jd-change', paint);

    // primera pintura ya con JD restaurado
    paint();
  }

  /* ===========
   * BOOT
   * =========== */
  function boot(){
    initDonuts();
    initUploader();
    initTooltips();
    initJobDesc();
    initBadges(); // <- ahora va después de initJobDesc
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();

})();

// Scroll automático al análisis si venimos de un submit
(function(){
  // Solo si venimos de un análisis recién hecho
  var el = document.getElementById('ai-analysis');
  if (!el) return;

  // Si el usuario prefiere menos animación:
  var prefersReduced = false;
  try {
    prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  } catch(e){}

  // Compensar navbar fija (ajustá 80 si tu navbar es más alta/baja)
  var NAV_OFFSET = 80;
  var y = el.getBoundingClientRect().top + window.pageYOffset - NAV_OFFSET;

  window.scrollTo({
    top: y,
    behavior: prefersReduced ? 'auto' : 'smooth'
  });
})();
</script>
{% endblock %}








